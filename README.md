# SolenoidStokeUNIT

<img src="https://github.com/akita11/SolenoidStrokeUNIT/blob/main/SolenoidStrokeUNIT.jpg" width="240px">

ソレノイドのストローク位置によってインダクタンスが変化し、PWM制御時の電流波形が変化することを利用して、ソレノイドのPWM制御とストローク位置の計測（推定）を同時に行うための回路です。

**【注意：重要】**
実際の制御・計測の動作には、ソレノイドごとに特性の計測を行う必要があり、また特性の個体差、温度特性なども考慮する必要があります。そのため、**「これを使ってサンプルプログラムを書き込めば間違いなく動作する（制御ができる）」というものではなく、あくまでもこの原理検証の実験のための回路**ということをご理解ください。測定原理やサンプルプログラムは[こちら](https://github.com/akita11/SolenoidStrokeMeasureControl)に適宜まとめて更新していきます。


## 使い方

オレンジ色のコネクタ(VH3.96-4p)に、ソレノイド用の電源とソレノイドを接続します。M5Stackの[BAVGソケット](https://www.switch-science.com/products/7234)を使うと、電源は2.1mmプラグ、負荷はスプリング端子で接続できて便利です。

Grove端子にUART通信元（M5Stack等のマイコンやUSBシリアル変換器）を接続し、本UNITに対してコマンド送信や結果の受信を行います。Grove端子の信号は、"RXD(受信) / TXD(送信) / VDD(+5V) / GND"の順です。ここでRXDとTXDの「主語」は本UNITです。つまり本UNITの"RXD"は、UART送信元の送信(TX)に接続します。（なおM5StackのPortCのTX/RXはこの順序ですのでそのまま接続できます）

### コマンド

コマンドは、基本的に、「コマンドを表す1文字 + 引数（10進数表記：ないものもある） + <CR> or <LF>」の形式です。各コマンドの成功時には'S'と'P'以外では指定された設定が返され、定義されていないコマンドでは'?'が返されます。

- 'S' : 測定開始（引数なし）：後述の形式で測定データが送出されます
- 'P' : 測定停止（引数なし）
- 'D' : PWM ON時間の設定（引数：PWM ON時間（単位は0.8us））
- 'T' : PWM ON時間の設定（引数：PWM周期（単位は0.8us））
- '0' : PWM ONから第1サンプリング点までの時間（引数：PWM周期（単位は0.8us））
- '1' : PWM ONから第2サンプリング点までの時間（引数：PWM周期（単位は0.8us））
- 'C' : 内部蓄積回数（引数：回）

### 送出データの形式

AAAABBBB + <CR> + <LF>

- AAAA : 第1サンプリング点の電圧値（10進数4桁）：0=0V, 1023=5V
- BBBB : 第2サンプリング点の電圧値（10進数4桁）：0=0V, 1023=5V


### 増幅率の調整

ソレノイドの駆動電流を0.2Ωの抵抗で電圧変換し、それをオペアンプ（非反転増幅回路）で増幅して"ADC"端子に出力しています。その増幅率は、用いるソレノイド・電源電圧からきまる駆動電流にあわせて、適切な範囲に調整する必要があります。"ADC"端子の波形をオシロ等で計測し、用いるマイコンのADCの入力電圧範囲に収まるように増幅率を調整します。増幅率は基板裏面のハンダジャンパJP3/JP4JP5で調整できます。（JP3は初期状態でONになっていますので、OFFにする場合はパターンをカットしてください）

- JP3/JP4/JP5=ON/OFF/OFF : 101倍
- JP3/JP4/JP5=ON/ON/OFF : 39倍
- JP3/JP4/JP5=ON/OFF/ON : 20倍
- JP3/JP4/JP5=ON/ON/ON : 16倍
- JP3/JP4/JP5=OFF/OFF/OFF : R1にとりつける抵抗から決まる倍率（(R1÷1[kΩ]+1)倍）

<img src="https://github.com/akita11/SolenoidStrokeUNIT/blob/main/SolenoidStrokeUNIT_back.jpg" width="240px">


## 測定原理

ソレノイドは電気回路的にはインダクタで、そのインダクタンスはストローク（プランジャ）位置で変化します。そのためON時の充電電流の波形は、ストローク位置で変化します。ただし充電開始時の電流はOFF期間中の放電特性できまるため、ゼロからとは限りません。またPWMのON時間（PWMのデューティー比）によっても波形は変化します。

ソレノイドによっては、ON後の2箇所の時点（例えば100us後と700us後）での電流の差が、PWMのON時間（PWMのデューティー比）ごとにストローク位置に伴って変化するため、与えているPWM ON時間とその電流差から、ストローク位置を計測（推定）することができます。具体的には、PWM ON後に電流が徐々に増加するところの2点（第1・第2サンプリング点）の電圧から、あらかじめ学習させた深層学習CNNモデルによってソレノイドのストローク位置とコイル温度を求めることができます。詳細はarXivの[論文(1)](https://arxiv.org/abs/2405.11721)と[論文(2)](https://arxiv.org/abs/2411.07270)にまとめてあります。

ただしソレノイドによっては、この電流差がストロークによってほとんど変化しないため、この方法では位置を計測することができません。そのため、複数点の電流の計測値から、予め計測した位置と電流値との差（の総和）が最小となるように反復計算で位置を求めるアルゴリズムを開発中です。まだ安定性や精度の検証は不十分ですが、参考用に上記GitHubにいくつかのソレノイドのCNNモデルと、それをESP32(M5Stack等)で実行するためのソースコードをおいてあります。

現在、SSBH-0830-02用の推定モデルとそれを使った位置制御(Control_ESP32/)をおいてあります。上記GitHubの生活をREADME.mdは別の計測制御(SolenoidStokeMeasureControlUNIT)用の情報が書いてありますが、この位置制御のソースコードは、本ユニット用のものです。



## Author

Junichi Akita (akita@ifdl.jp, @akita11)




